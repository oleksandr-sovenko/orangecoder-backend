<!--
gpio.f7.html
Copyright (C) 2019 Oleksandr Sovenko (info@oleksandrsovenko.com)

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->

<template>
    <div class="page" data-name="gpio">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">{{_t 'Back'}}</span>
                    </a>
                </div>
                <div class="title">{{_t 'GPIO'}}</div>
                <div class="right">
                    <a href="#" class="link popup-open" data-popup=".popup-table-gpio">
                        <i class="material-icons">developer_board</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
            <div class="block-title">{{_t 'List GPIO Devices'}}</div>

            <div class="data-table data-table-init card">
                <div class="card-header">
                    <div class="data-table-links">
                        <a class="link" @click="openPopup('.popup-add-device', null, 'addDevice')">
                        	<i class="material-icons">add_circle_outline</i> {{_t 'Add'}}
                        </a>
                    </div>
                    <div class="data-table-actions">
                        <a class="link icon-only">
                            <i class="icon f7-icons if-not-md">sort</i>
                            <i class="icon material-icons md-only">sort</i>
                        </a>
                        <a class="link icon-only">
                            <i class="icon f7-icons if-not-md">more_vertical_round</i>
                            <i class="icon material-icons md-only">more_vert</i>
                        </a>
                    </div>
                </div>
                <div class="card-content">
                    <table>
                         <thead>
                            <tr>
                                <th class="label-cell">{{_t 'Name'}}</th>
                                <th class="label-cell">{{_t 'Device'}}</th>
                                <th class="label-cell">{{_t 'PINs / ADDRs'}}</th>
                                <th class="label-cell text-align-center">{{_t 'Activity'}}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each gpio.devices}}
                                <tr data-id="{{id}}">
                                    <td class="label-cell" width="100%">{{name}}</td>
                                    <td class="label-cell" nowrap>{{device.toUpperCase()}}</td>
                                    <td class="label-cell" nowrap>{{e_pins pins}}</td>
                                    <td class="label-cell text-align-center" nowrap>
                                        {{#js_if " this.device === 'hc-sr501' "}}
                                            <i class="material-icons device-{{id}}" style="font-size: 24px; padding-top: 5px;">speaker_phone</i>
                                        {{/js_if}}

                                        {{#js_if " this.device === 'ds18b20' "}}
                                            <span class="device-{{id}}">-</span>
                                        {{/js_if}}
                                    </td>
                                    <td class="actions-cell" nowrap>
                                        <a class="link icon-only" @click="openPopup('.popup-edit-device', '{{id}}', 'editDevice')">
                                            <i class="material-icons">edit</i>
                                        </a>
                                        <a class="link icon-only" @click="removeDevice">
                                            <i class="material-icons">delete</i>
                                        </a>
                                    </td>
                                </tr>
                            {{else}}
                                <tr>
                                    <td colspan="6" class="text-align-center">{{_t 'No devices yet'}}</td>
                                </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer"></div>
            </div>
        </div>

        <!-- popup-edit-device -->
        <div class="popup popup-edit-device">
            <div class="block-title">{{_t 'Edit GPIO Device'}}</div>
            <div class="list no-hairlines">
                <form>
                    <input type="hidden" name="id" value="">
                    <ul>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Name'}}</div>
                                <div class="item-input-wrap">
                                    <input name="name" type="text" placeholder="Довільна назва">
                                    <span class="input-clear-button"></span>
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Device'}}</div>
                                <div class="item-input-wrap">
                                    <select name="device">
                                        {{#each devices}}
                                            <option value="{{@key}}" selected>{{title}}</option>
                                        {{/each}}
                                    <select>
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info item-input-pins">
                            <div class="item-inner">
                                <div class="row">

                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Description'}}</div>
                                <div class="item-input-wrap description">
                                </div>
                            </div>
                        </li>
                    </ul>
                </form>
            </div>

            <div class="block block-bottom">
                <p class="row">
                    <button class="col button button-raised button-fill submit">{{_t 'Save'}}</button>
                    <button class="col button button-raised popup-close">{{_t 'Close'}}</button>
                </p>
            </div>
        </div>
        <!-- /popup-edit-device -->

        <!-- popup-add-device -->
        <div class="popup popup-add-device">
            <div class="block-title">{{_t 'New GPIO Device'}}</div>
            <div class="list no-hairlines">
                <form>
                    <ul>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Name'}}</div>
                                <div class="item-input-wrap">
                                    <input name="name" type="text">
                                    <span class="input-clear-button"></span>
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Device'}}</div>
                                <div class="item-input-wrap">
                                    <select name="device">
                                        {{#each devices}}
                                            <option value="{{@key}}" selected>{{title}}</option>
                                        {{/each}}
                                    <select>
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info item-input-pins">
                            <div class="item-inner">
                                <div class="row">

                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input item-input-with-info">
                            <div class="item-inner">
                                <div class="item-title item-label">{{_t 'Description'}}</div>
                                <div class="item-input-wrap description">
                                </div>
                            </div>
                        </li>
                    </ul>
                </form>
            </div>

            <div class="block block-bottom">
                <p class="row">
                    <button class="col button button-raised button-fill submit">{{_t 'Add'}}</button>
                    <button class="col button button-raised popup-close">{{_t 'Close'}}</button>
                </p>
            </div>
        </div>
        <!-- /popup-add-device -->

        <!-- popup-table-gpio -->
        <div class="popup popup-table-gpio">
            <div class="block-title">{{_t 'Orange Pi GPIO Pinout'}}</div>

            <div class="block">
                <table class="table" width="100%">
                    <thead>
                        <tr>
                            <th class="text-align-center">{{_t 'wPi'}}</th>
                            <th class="text-align-center">{{_t 'Name'}}</th>
                            <th class="text-align-center">{{_t 'Mode'}}</th>
                            <th class="text-align-center">{{_t 'Physical'}}</th>
                            <th class="text-align-center">{{_t 'Physical'}}</th>
                            <th class="text-align-center">{{_t 'Mode'}}</th>
                            <th class="text-align-center">{{_t 'Name'}}</th>
                            <th class="text-align-center">{{_t 'wPi'}}</th>
                        </tr>
                    </thead>
                    <tbody>
						<tr>
                        	{{#each gpio.readall}}
                        		{{#js_if " parseInt(this.Physical) % 2 == 0 " }}
                                	<td class="text-align-center">{{Physical}}</td>
                                	<td class="text-align-center">{{Mode}}</td>
                                	<td class="text-align-center">{{Name}}</td>
                                	<td class="text-align-center">{{wPi}}</td>
                        			</tr><tr>
                                {{else}}
                                	<td class="text-align-center">{{wPi}}</td>
                                	<td class="text-align-center">{{Name}}</td>
                                	<td class="text-align-center">{{Mode}}</td>
                                	<td class="text-align-center">{{Physical}}</td>
                                {{/js_if}}
                        	{{/each}}
						</tr>
                    </tbody>
                </table>
            </div>

            <div class="block block-bottom">
                <button class="col button button-raised popup-close">{{_t 'Close'}}</button>
            </div>
        </div>
        <!-- /popup-table-gpio -->
    </div>
</template>

<script>
export default {
    style: `
        .popup-table-gpio th {
            background: var(--f7-messagebar-attachments-border-color);
        }

        .popup-table-gpio td {
            background: var(--f7-list-group-title-bg-color);
        }
    `,
    methods: {
        /** Remove device
         *  @el
         */
        removeDevice(el) {
            var self = this,
                id = this.$$(el.target).closest('tr').data('id');

            self.$app.dialog.confirm('Remove?', 'Delete', function() {
                self.$app.request({
                    url: self.$app.data.url + '/gpio/device/' + id,
                    method: 'DELETE',
                    dataType: 'json',
                    success: function(data, status, xhr) {
                        if (data.success) {
                            self.$app.methods.gpio.devices(function(devices) {
                                self.gpio.devices = devices;
                                self.$update();
                            });
                        } else {
                            self.$app.dialog.alert(data.msg, 'Error');
                        }
                    }
                });
            });
        },


        /** Edit a device
         *
         */
        editDevice(data, popup) {
            var self = this;

            data.pins = {};
            popup.find('[name="pins"]').each(function(i, e) {
                 data.pins[e.getAttribute('data-pin')] = e.value;
            });

            self.$app.request({
                url: self.$app.data.url + '/gpio/device/' + data.id,
                data: data,
                contentType: 'application/json',
                method: 'POST',
                dataType: 'json',
                success: function(data, status, xhr) {
                    if (data.success) {
                        self.$app.methods.gpio.devices(function(devices) {
                            self.gpio.devices = devices;
                            self.$update();

                            if (popup !== undefined)
                                self.$app.popup.close(popup);
                        });
                    } else {
                        self.$app.dialog.alert(data.msg, 'Error');
                    }
                }
            });
        },


        /** Add a device
         *
         */
        addDevice(data, popup) {
            var self = this;

            data.pins = {};
            popup.find('[name="pins"]').each(function(i, e) {
                 data.pins[e.getAttribute('data-pin')] = e.value;
            });

            self.$app.request({
                url: self.$app.data.url + '/gpio/device',
                data: data,
                contentType: 'application/json',
                method: 'PUT',
                dataType: 'json',
                success: function(data, status, xhr) {
                    if (data.success) {
                        self.$app.methods.gpio.devices(function(devices) {
                            self.gpio.devices = devices;
                            self.$update();

                            if (popup !== undefined)
                                self.$app.popup.close(popup);
                        });
                    } else {
                        self.$app.dialog.alert(data.msg, 'Error');
                    }
                }
            });
        },


        /** Open a popup
         *
         */
        openPopup(class_name, id, method) {
            var self = this,
                popup = self.$$(self.$$(class_name)[0].cloneNode(true));

            popup.on('popup:closed', function(e) {
                popup.remove();
            });

            popup.find('.submit').on('click', function() {
                if (method !== undefined) {
                    var data = self.$app.form.convertToData(popup.find('form'));

                    self[method](data, popup);
                }

                self.$app.popup.close(popup);
            });

            popup.find('[name="device"]').on('change', function() {
                var value = self.$$(this).val();
                popup.find('.description').html(self.devices[value].description);

                var html = '';

                for (var i in self.devices[value].pins) {
                    var slug = self.devices[value].pins[i],
                        title = slug.toUpperCase();

                    if (value == 'ds18b20') {
                        html += `
                            <div class="col-25 pin-wrap pin-1-wrap">
                                <div class="item-title item-label">Device</div>
                                <div class="item-input-wrap">
                                    <select name="pins" data-pin="addr">`;

                        for (var j in self.w1.devices) {
                            var item = self.w1.devices[j];
                                html += `<option value="${item}">${item}</option>`;
                        }

                        html += `
                                    <select>
                                </div>
                            </div>`;
                    }

                    if (value == 'hc-sr501' || value == 'mpu-6050' || value == 'hc-sr04') {
                        html += `
                            <div class="col-25 pin-wrap pin-1-wrap">
                                <div class="item-title item-label">PIN (${title})</div>
                                <div class="item-input-wrap">
                                    <select name="pins" data-pin="${slug}">`;

                        for (var j in self.gpio.readall) {
                            var item = self.gpio.readall[j];

                            if (item.wPi !== '')
                                html += `<option value="${item.wPi}">${item.Physical} - (${item.Name})</option>`;
                        }

                        html += `
                                    <select>
                                </div>
                            </div>`;
                    }
                }

                popup.find('.item-input-pins .row').html(html);
            });

            if (id !== null) {
                self.$app.request({
                    url: self.$app.data.url + '/gpio/device/' + id,
                    method: 'GET',
                    dataType: 'json',
                    success: function(fields, status, xhr) {
                        for (var name in fields) {
                            if (name == 'pins') {
                                var pins = fields[name];

                                popup.find('[name="' + name + '"]').trigger('change');

                                for (var name in pins)
                                    popup.find('[data-pin="' + name+ '"]').val(pins[name]);
                            } else
                                popup.find('[name="' + name + '"]').val(fields[name]).trigger('change');
                        }
                    }
                });
            } else {
                popup.find('[name="device"]').trigger('change');
            }

            self.$app.popup.open(popup);
        }
    },

    data: function() {
        return {
            gpio: {
                devices: this.$app.data.gpio.devices,
                readall: this.$app.data.gpio.readall,
            },
            w1: {
                devices: this.$app.data.w1.devices,
            },
            devices: {
                'hc-sr501': {
                    title: 'Датчик руху HC-SR501',
                    description: '555 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus quibusdam!',
                    pins: ['out']
                },
                'mpu-6050': {
                    title: 'Акселерометр і гіроскоп GY-521 (MPU-6050)',
                    description: '444 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus quibusdam!',
                    pins: ['sda', 'scl']
                },
                'hc-sr04': {
                    title: 'Ультразвуковий датчик відстані HC-SR04',
                    description: '333 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus quibusdam!',
                    pins: ['echo', 'trig']
                },
                'ds18b20': {
                    title: 'Датчик температури DS18B20',
                    description: '222 Lorem ipsum dolor sit amet, consectetur adipisicing elit. Magni molestiae laudantium dignissimos est nobis delectus nemo ea alias voluptatum architecto, amet similique, saepe iste consectetur in repellat ut minus quibusdam!',
                    pins: ['out']
                }
            }
        }
    },
};
</script>